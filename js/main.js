// Generated by CoffeeScript 1.6.2
(function() {
  var ASSETS, BULLET_IMG, Bullet, Enemy, Material, PLAYER_IMG, Player, add, enemies, enemy_bullets, game, intoWindow, isInWindow, player_bullets, players, remove,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  enchant();

  ASSETS = [PLAYER_IMG = 'player.png', BULLET_IMG = 'icon0.png'];

  game = null;

  players = null;

  enemies = null;

  player_bullets = null;

  enemy_bullets = null;

  add = function(inst) {
    return game.currentScene.addChild(inst);
  };

  remove = function(inst) {
    return game.currentScene.removeChild(inst);
  };

  isInWindow = function(node) {
    var _ref, _ref1;

    return (0 <= (_ref = node.x) && _ref < game.width) && (0 <= (_ref1 = node.y) && _ref1 < game.height);
  };

  intoWindow = function(node) {
    var t;

    if (node.x < 0) {
      node.x = 0;
    }
    t = game.width - 1 - node.width;
    if (node.x > t) {
      node.x = t;
    }
    if (node.y < 0) {
      node.y = 0;
    }
    t = game.height - 1 - node.height;
    if (node.y > t) {
      return node.y = t;
    }
  };

  Material = (function(_super) {
    __extends(Material, _super);

    function Material(img_name, frame, width, height, group) {
      this.group = group;
      Material.__super__.constructor.call(this, width, height);
      this.image = game.assets[img_name];
      this.frame = frame;
      this.group.addChild(this);
      this.hp = 1;
      this.power = 1;
    }

    Material.prototype.damage = function(material) {
      this.hp -= material.power;
      if (this.hp <= 0) {
        return this.hp = 0;
      }
    };

    Material.prototype.attack = function(material) {
      material.damage(this);
      return this.damage(material);
    };

    return Material;

  })(Sprite);

  Player = (function(_super) {
    __extends(Player, _super);

    function Player() {
      Player.__super__.constructor.call(this, PLAYER_IMG, 27, 32, 32, players);
      this.scale(2, 2);
      this.x = game.width / 2;
      this.y = game.height / 2;
    }

    Player.prototype.onenterframe = function() {
      if (game.frame % (game.fps / 10) === 0) {
        new Bullet(this.x, this.y + this.height / 2, 0, -10, player_bullets);
        return new Bullet(this.x + this.width / 2, this.y + this.height / 2, 0, -10, player_bullets);
      }
    };

    return Player;

  })(Material);

  Enemy = (function(_super) {
    __extends(Enemy, _super);

    function Enemy(x, y) {
      Enemy.__super__.constructor.call(this, PLAYER_IMG, 27, 32, 32, enemies);
      this.scale(2, -2);
      this.x = x;
      this.y = y;
      this.hp = 10;
    }

    Enemy.prototype.onenterframe = function() {
      var angle, i, n, vx, vy, _i, _results;

      if (game.frame % (game.fps / 5) === 0) {
        angle = 0;
        n = 72;
        _results = [];
        for (i = _i = 1; 1 <= n ? _i <= n : _i >= n; i = 1 <= n ? ++_i : --_i) {
          vx = Math.cos(angle) * 2;
          vy = Math.sin(angle) * 2;
          new Bullet(this.x + this.width / 4, this.y + this.height / 4, vx, vy, enemy_bullets);
          _results.push(angle += Math.PI * 2 / n);
        }
        return _results;
      }
    };

    return Enemy;

  })(Material);

  Bullet = (function(_super) {
    __extends(Bullet, _super);

    function Bullet(x, y, vx, vy, group) {
      var angle;

      this.vx = vx;
      this.vy = vy;
      Bullet.__super__.constructor.call(this, BULLET_IMG, 48, 16, 16, group);
      this.x = x;
      this.y = y;
      angle = Math.atan(this.vx, this.vy) / Math.PI * 180;
      if (this.vy > 0) {
        angle = 180 - angle;
      }
      this.rotate(angle);
    }

    Bullet.prototype.onenterframe = function() {
      this.x += this.vx;
      this.y += this.vy;
      if (!isInWindow(this)) {
        return this.hp = 0;
      }
    };

    return Bullet;

  })(Material);

  window.onload = function() {
    game = new Game(400, 600);
    game.fps = 60;
    game.preload(ASSETS);
    game.onload = function() {
      var bex, bey, i, player, scene, _i;

      scene = game.rootScene;
      scene.backgroundColor = '#ffffff';
      players = new Group;
      add(players);
      enemies = new Group;
      add(enemies);
      player_bullets = new Group;
      add(player_bullets);
      enemy_bullets = new Group;
      add(enemy_bullets);
      player = new Player;
      for (i = _i = 1; _i <= 2; i = ++_i) {
        new Enemy(game.width / 3 * i, game.height / 3);
      }
      scene.onenterframe = function() {
        var char_set, char_sets, first, m, second, set, _j, _k, _l, _len, _len1, _len2, _ref, _ref1, _results;

        _ref = [player_bullets, enemy_bullets, players, enemies];
        for (_j = 0, _len = _ref.length; _j < _len; _j++) {
          set = _ref[_j];
          _ref1 = set.childNodes;
          for (_k = 0, _len1 = _ref1.length; _k < _len1; _k++) {
            m = _ref1[_k];
            if ((m != null ? m.hp : void 0) <= 0) {
              m.group.removeChild(m);
            }
          }
        }
        char_sets = [[player_bullets, enemies], [enemy_bullets, players], [enemies, players]];
        _results = [];
        for (_l = 0, _len2 = char_sets.length; _l < _len2; _l++) {
          char_set = char_sets[_l];
          _results.push((function() {
            var _len3, _m, _ref2, _results1;

            _ref2 = char_set[0].childNodes;
            _results1 = [];
            for (_m = 0, _len3 = _ref2.length; _m < _len3; _m++) {
              first = _ref2[_m];
              _results1.push((function() {
                var _len4, _n, _ref3, _results2;

                _ref3 = char_set[1].childNodes;
                _results2 = [];
                for (_n = 0, _len4 = _ref3.length; _n < _len4; _n++) {
                  second = _ref3[_n];
                  if (first.intersect(second)) {
                    _results2.push(first.attack(second));
                  } else {
                    _results2.push(void 0);
                  }
                }
                return _results2;
              })());
            }
            return _results1;
          })());
        }
        return _results;
      };
      bex = bey = 0;
      scene.ontouchstart = function(e) {
        bex = e.x;
        return bey = e.y;
      };
      return scene.ontouchmove = function(e) {
        player.x += e.x - bex;
        player.y += e.y - bey;
        intoWindow(player);
        bex = e.x;
        return bey = e.y;
      };
    };
    return game.start();
  };

}).call(this);
